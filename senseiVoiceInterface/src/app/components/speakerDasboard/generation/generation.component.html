<div class="container py-4">
  <div class="content">
    <!-- Voice Hero Card - Prominent Voice Showcase -->
    <div class="voice-hero-card" *ngIf="selectedVoice">
      <div class="voice-hero-content">
        <div class="voice-hero-left">
          <div class="voice-avatar-large">
            <img [src]="selectedVoice.avatar" [alt]="selectedVoice.name" class="hero-avatar-img">
          </div>
          <div class="voice-hero-info">
            <h2 class="voice-hero-name">{{ selectedVoice.name }}</h2>
            <div class="voice-hero-badges">
              <span class="hero-badge hero-badge-type">{{ selectedVoice.type }}</span>
              <span class="hero-badge hero-badge-lang">{{ selectedVoice.language }}</span>
              <span class="hero-badge hero-badge-gender">{{ selectedVoice.gender }}</span>
              <span class="hero-badge hero-badge-age">{{ selectedVoice.ageZone }}</span>
            </div>
            <div class="voice-hero-actions">
              <button class="hero-play-btn" (click)="playOriginalVoice(selectedVoice)">
                <i class="bi bi-play-fill"></i>
                {{ 'voiceSelection.buttons.original' | translate }}
              </button>
              <button class="hero-play-btn secondary" (click)="playClonedVoice(selectedVoice)">
                <i class="bi bi-play-fill"></i>
                {{ 'voiceSelection.buttons.cloned' | translate }}
              </button>
            </div>
          </div>
        </div>
        <div class="voice-hero-right">
          <div class="voice-hero-waveform">
            <button class="btn-change-voice" (click)="selectedVoice = null" style="width: 200px;">
              <i class="bi bi-arrow-left me-2"></i>
              {{ 'voiceShowcase.changeVoice' | translate }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="generation-tabs" *ngIf="selectedVoice">
      <button class="tab-button" 
              [class.active]="activeTab === 'free'" 
              (click)="setActiveTab('free')">
        <i class="bi bi-gift me-2"></i>
        {{ 'tabs.freeTest' | translate }}
      </button>
      <button class="tab-button" 
              [class.active]="activeTab === 'request'" 
              (click)="setActiveTab('request')">
        <i class="bi bi-cart me-2"></i>
        {{ 'tabs.audioRequest' | translate }}
      </button>
    </div>

    <!-- Generation Content -->
    <div class="generation-content" *ngIf="selectedVoice">
      <!-- Free Test Tab -->
      <div class="tab-content" *ngIf="activeTab === 'free'">
        <div class="generation-card">
          <div class="generation-header">
            <h3>{{ 'tabs.freeTest' | translate }}</h3>
            <div class="character-counter" [class.text-danger]="isTextOverLimit()">
              {{ actionData.text.length }}/{{ freeTestCharLimit }}
            </div>
          </div>

          <div class="text-input-section">
            <textarea 
              class="generation-textarea"
              [(ngModel)]="actionData.text"
              [class.text-danger]="isTextOverLimit()"
              (input)="limitText()" 
              (ngModelChange)="checkTextLength()"
              [placeholder]="'Enter your text here...' | translate">
            </textarea>
            
            <div class="character-limit-warning" *ngIf="isTextOverLimit()">
              <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                {{ 'characterLimit.warning' | translate }}
              </div>
            </div>
          </div>

          <div class="generation-info">
            <div class="info-badges">
              <span class="info-badge">
                <i class="bi bi-calculator me-1"></i>
                {{ 'info.total' | translate }} {{ calculateTotal() }}
              </span>
            </div>
          </div>

          <div class="generation-actions">
            <div class="project-selection" *ngIf="!showProjectSelection">
              <button class="project-btn" (click)="toggleProjectSelection()">
                <i class="bi bi-folder2 me-2"></i>
                {{ selectedProject ? selectedProject.name : ('projectSelection.selectProjectBtn' | translate) }}
              </button>
            </div>

            <button class="generate-btn" 
                    (click)="generateSpeech()" 
                    [disabled]="isGenerating || !selectedVoice">
              <i class="bi" [ngClass]="isGenerating ? 'bi-hourglass-split' : 'bi-play-fill'"></i>
              {{ isGenerating ? 'Generating...' : 'Generate Speech' }}
            </button>
          </div>

          <!-- Custom Audio Player -->
          <div class="custom-audio-player" *ngIf="audioUrl">
            <audio #audioPlayer 
                   [src]="audioUrl" 
                   (loadedmetadata)="onAudioLoaded()" 
                   (timeupdate)="onTimeUpdate()" 
                   (ended)="onAudioEnded()"
                   (error)="onAudioError($event)"
                   style="display: none;"
                   preload="metadata">
            </audio>

            <div class="audio-player-container">
              <div class="audio-player-header">
                <div class="audio-voice-info">
                  <img [src]="selectedVoice.avatar" [alt]="selectedVoice.name" class="audio-voice-avatar">
                  <div class="audio-voice-details">
                    <span class="audio-voice-name">{{ selectedVoice.name }}</span>
                    <span class="audio-voice-type">{{ selectedVoice.type }} • {{ selectedVoice.language }}</span>
                  </div>
                </div>
                <div class="audio-time-display">
                  <span class="current-time">{{ formatTime(currentTime) }}</span>
                  <span class="time-separator">/</span>
                  <span class="total-time">{{ formatTime(duration) }}</span>
                </div>
              </div>

              <div class="audio-waveform-container">
                <div class="audio-waveform-bars">
                  <div class="audio-waveform-bar" *ngFor="let bar of waveformBars" [style.height.%]="isAudioPlaying ? bar : 20"></div>
                </div>
              </div>

              <div class="audio-progress-container" (click)="seekAudio($event)">
                <div class="audio-progress-bar">
                  <div class="audio-progress-fill" [style.width.%]="progressPercentage"></div>
                  <div class="audio-progress-handle" [style.left.%]="progressPercentage"></div>
                </div>
              </div>

              <div class="audio-controls">
                <button class="audio-play-btn" (click)="togglePlayPause()" [disabled]="!audioUrl">
                  <i class="bi" [ngClass]="isAudioPlaying ? 'bi-pause-fill' : 'bi-play-fill'"></i>
                </button>

                <div class="audio-volume-controls">
                  <button class="volume-btn" (click)="toggleMute()">
                    <i class="bi" [ngClass]="volumeIcon"></i>
                  </button>
                  <input type="range" 
                         class="volume-slider" 
                         min="0" 
                         max="100" 
                         [(ngModel)]="volume" 
                         (input)="setVolume($event)">
                </div>
              </div>
            </div>
          </div>

          <!-- Generation Status Messages -->
          <div class="generation-status" *ngIf="generationSuccess || generationError">
            <div class="alert alert-success" *ngIf="generationSuccess">
              <i class="bi bi-check-circle me-2"></i>
              {{ 'generation.success' | translate }}
              <span *ngIf="selectedProject">{{ 'generation.andSavedTo' | translate }} "{{ selectedProject.name }}"</span>!
            </div>
            <div class="alert alert-danger" *ngIf="generationError">
              <i class="bi bi-exclamation-triangle me-2"></i>
              {{ generationError }}
            </div>
          </div>
        </div>
      </div>

      <!-- Audio Request Tab -->
      <div class="tab-content" *ngIf="activeTab === 'request'">
        <div class="generation-card">
          <div class="generation-header">
            <h3>{{ 'tabs.audioRequest' | translate }}</h3>
            <div class="character-counter">
              {{ actionData.text.length }} {{ 'info.characters' | translate }}
            </div>
          </div>

          <div class="text-input-section">
            <textarea 
              class="generation-textarea"
              [(ngModel)]="actionData.text"
              [placeholder]="'Enter your text for audio request...' | translate">
            </textarea>
          </div>

          <div class="generation-info">
            <div class="info-badges">
              <span class="info-badge">
                <i class="bi bi-calculator me-1"></i>
                {{ 'info.total' | translate }} {{ price * actionData.text.length }}
              </span>
            </div>
          </div>

          <div class="generation-actions">
            <button class="checkout-btn" 
                    (click)="generateSpeech()" 
                    [disabled]="!selectedVoice || actionData.text.length === 0">
              <i class="bi bi-cart me-2"></i>
              {{ 'checkout.proceedToCheckout' | translate }}
            </button>
          </div>

          <div class="pricing-info">
            <h5>{{ 'checkout.pricingInformation' | translate }}</h5>
            <div class="pricing-details">
              <div class="pricing-item total">
                <span>{{ 'checkout.totalPrice' | translate }}</span>
                <span class="pricing-value">{{ price * actionData.text.length }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Voice Selection Section -->
    <div class="voice-selection-section" *ngIf="!selectedVoice" [class.collapsed]="selectedVoice">

      <!-- Search and Filters -->
      <!-- Filters -->
      <div class="filters-section">
        <div class="filters-grid" [class.darija-active]="isDarijaSelected()">
          <input type="text" 
                 class="filter-input" 
                 [placeholder]="'voiceSelection.searchPlaceholder' | translate" 
                 [(ngModel)]="filters.search" 
                 (input)="applyFilters()">
          
          <select class="filter-select" [(ngModel)]="filters.type" (change)="applyFilters()">
            <option value="">{{ 'voiceSelection.filters.allTypes' | translate }}</option>
            <option value="premade">{{ 'voiceSelection.filters.ai' | translate }}</option>
            <option value="professional">{{ 'voiceSelection.filters.cloned' | translate }}</option>
          </select>
          
          <select class="filter-select" [(ngModel)]="filters.language" (change)="applyFilters()">
            <option value="">{{ 'voiceSelection.filters.allLanguages' | translate }}</option>
            <option *ngFor="let lang of languages" [value]="lang.code">
              {{ lang.name }}
            </option>
          </select>
          
          
          <select class="filter-select" [(ngModel)]="filters.gender" (change)="applyFilters()">
            <option value="">{{ 'voiceSelection.filters.allGenders' | translate }}</option>
            <option value="male">{{ 'voiceSelection.filters.male' | translate }}</option>
            <option value="female">{{ 'voiceSelection.filters.female' | translate }}</option>
          </select>
          
          <select class="filter-select" [(ngModel)]="filters.ageZone" (change)="applyFilters()">
            <option value="">{{ 'voiceSelection.filters.allAges' | translate }}</option>
            <option value="young">{{ 'voiceSelection.filters.young' | translate }}</option>
            <option value="middle_aged">{{ 'voiceSelection.filters.adult' | translate }}</option>
            <option value="old">{{ 'voiceSelection.filters.senior' | translate }}</option>
          </select>
          
          <button class="btn-reset-filters" (click)="resetFilters()">
            {{ 'voiceSelection.filters.resetAll' | translate }}
          </button>
        </div>
      </div>

      <!-- Voice Grid -->
      <div class="voice-grid">
        <div class="voice-card" 
             *ngFor="let voice of filteredVoices | paginate: { itemsPerPage: 6, currentPage: currentPage }"
             [class.selected]="selectedVoice && selectedVoice.id === voice.id"
             [attr.data-language]="voice.language"
             (click)="selectVoice(voice)">
          
          <div class="voice-card-header">
            <img [src]="voice.avatar" [alt]="voice.name" class="voice-card-avatar">
            <button class="voice-favorite-btn">
              <i class="bi bi-heart"></i>
            </button>
          </div>

          <div class="voice-card-content">
            <h4 class="voice-card-name">{{ voice.name }}</h4>
            <div class="voice-card-badges">
              <span class="voice-badge voice-badge-type">{{ voice.type }}</span>
              <span class="voice-badge voice-badge-lang">{{ voice.language }}</span>
            </div>
            
            <div class="voice-card-meta">
              <span class="voice-meta">{{ voice.gender }}</span>
              <span class="voice-meta-separator">•</span>
              <span class="voice-meta">{{ voice.ageZone }}</span>
            </div>
          </div>

          <div class="voice-card-actions">
            <button class="voice-preview-btn" (click)="playOriginalVoice(voice); $event.stopPropagation();">
              <i class="bi bi-play-fill"></i>
              {{ 'voiceSelection.buttons.original' | translate }}
            </button>
            <button class="voice-preview-btn secondary" (click)="playClonedVoice(voice); $event.stopPropagation();">
              <i class="bi bi-play-fill"></i>
              {{ 'voiceSelection.buttons.cloned' | translate }}
            </button>
          </div>

          <div class="voice-card-footer">
            <button class="voice-select-btn" (click)="selectVoice(voice); $event.stopPropagation();">
              <i class="bi bi-check-circle me-1"></i>
              {{ 'voiceSelection.buttons.useVoice' | translate }}
            </button>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div class="voice-pagination">
        <pagination-controls (pageChange)="currentPage = $event"></pagination-controls>
      </div>
    </div>

    <!-- Project Selection Modal -->
    <div class="project-selection-modal" *ngIf="showProjectSelection" (click)="toggleProjectSelection()">
      <div class="project-modal-content" (click)="$event.stopPropagation()">
        <div class="project-modal-header">
          <h3>{{ 'projectSelection.title' | translate }}</h3>
          <button class="modal-close-btn" (click)="toggleProjectSelection()">
            <i class="bi bi-x"></i>
          </button>
        </div>
        <div class="project-modal-body">
          <div class="alert alert-info" *ngIf="projects.length === 0">
            <i class="bi bi-info-circle me-2"></i>
            {{ 'projectSelection.noProjects' | translate }}
          </div>
          <div class="project-list">
            <div class="project-item" 
                 *ngFor="let project of projects"
                 [class.selected]="selectedProject && selectedProject.uuid === project.uuid"
                 (click)="selectProject(project)">
              <div class="project-info">
                <h5>{{ project.name }}</h5>
                <small>{{ project.dateCreation | date }}</small>
              </div>
              <div class="project-select-icon" *ngIf="selectedProject && selectedProject.uuid === project.uuid">
                <i class="bi bi-check-circle"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Character Limit Modal -->
    <div class="char-limit-modal" *ngIf="showCharLimitModal" (click)="cancelExceedLimit()">
      <div class="char-modal-content" (click)="$event.stopPropagation()">
        <div class="char-modal-header">
          <h3>{{ 'charLimit.title' | translate }}</h3>
          <button class="modal-close-btn" (click)="cancelExceedLimit()">
            <i class="bi bi-x"></i>
          </button>
        </div>
        <div class="char-modal-body">
          <p>{{ 'charLimit.message' | translate }}</p>
          <p class="text-danger">{{ 'charLimit.paidNotice' | translate }}</p>
          <div class="char-limit-breakdown">
            <div class="char-item">
              <span>{{ 'charLimit.freeChars' | translate }}:</span>
              <span class="char-value">100</span>
            </div>
            <div class="char-item">
              <span>{{ 'charLimit.yourChars' | translate }}:</span>
              <span class="char-value">{{ actionData.text.length }}</span>
            </div>
            <div class="char-item">
              <span>{{ 'charLimit.paidChars' | translate }}:</span>
              <span class="char-value">{{ actionData.text.length - 100 }}</span>
            </div>
            <div class="char-item total">
              <span>{{ 'charLimit.estimatedCost' | translate }}:</span>
              <span class="char-value">{{ price * (actionData.text.length - 100) }}</span>
            </div>
          </div>
        </div>
        <div class="char-modal-footer">
          <button class="btn-secondary" (click)="cancelExceedLimit()">
            {{ 'charLimit.cancel' | translate }}
          </button>
          <button class="btn-primary" (click)="acceptExceedLimit()">
            {{ 'charLimit.continue' | translate }}
          </button>
        </div>
      </div>
    </div>

    <!-- Payment Method Selection Modal -->
    <div class="payment-method-modal" *ngIf="showPaymentMethodModal" (click)="closePaymentMethodModal()">
      <div class="payment-modal-content" (click)="$event.stopPropagation()">
        <div class="payment-modal-header">
          <h3>{{ 'payment.selectMethod' | translate }}</h3>
          <button class="modal-close-btn" (click)="closePaymentMethodModal()">
            <i class="bi bi-x"></i>
          </button>
        </div>
        
        <div class="payment-modal-body">
          <div class="payment-summary">
            <h5>{{ 'payment.orderSummary' | translate }}</h5>
            <div class="summary-item total">
              <span>{{ 'payment.totalAmount' | translate }}:</span>
              <span class="total-price">${{ calculatedPrice.toFixed(2) }}</span>
            </div>
          </div>

          <div class="payment-methods">
            <h5>{{ 'payment.chooseMethod' | translate }}</h5>
            
            <div class="payment-method-option" 
                 [class.selected]="selectedPaymentMethod === 'paypal'"
                 (click)="selectPaymentMethod('paypal')">
              <div class="payment-method-icon">
                <i class="bi bi-paypal"></i>
              </div>
              <div class="payment-method-info">
                <h6>PayPal</h6>
                <p>{{ 'payment.paypalDesc' | translate }}</p>
              </div>
              <div class="payment-method-check" *ngIf="selectedPaymentMethod === 'paypal'">
                <i class="bi bi-check-circle-fill"></i>
              </div>
            </div>

            <div class="payment-method-option" 
                 [class.selected]="selectedPaymentMethod === 'card'"
                 (click)="selectPaymentMethod('card')">
              <div class="payment-method-icon">
                <i class="bi bi-credit-card"></i>
              </div>
              <div class="payment-method-info">
                <h6>{{ 'payment.creditCard' | translate }}</h6>
                <p>{{ 'payment.cardDesc' | translate }}</p>
              </div>
              <div class="payment-method-check" *ngIf="selectedPaymentMethod === 'card'">
                <i class="bi bi-check-circle-fill"></i>
              </div>
            </div>

            <div class="payment-method-option" 
                 [class.selected]="selectedPaymentMethod === 'verment'"
                 (click)="selectPaymentMethod('verment')">
              <div class="payment-method-icon">
                <i class="bi bi-bank"></i>
              </div>
              <div class="payment-method-info">
                <h6>{{ 'payment.verment' | translate }}</h6>
                <p>{{ 'payment.vermentDesc' | translate }}</p>
              </div>
              <div class="payment-method-check" *ngIf="selectedPaymentMethod === 'verment'">
                <i class="bi bi-check-circle-fill"></i>
              </div>
            </div>
          </div>

          <div class="payment-error" *ngIf="paymentError">
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>
              {{ paymentError }}
            </div>
          </div>
        </div>

        <div class="payment-modal-footer">
          <button class="btn-secondary" (click)="closePaymentMethodModal()">
            {{ 'payment.cancel' | translate }}
          </button>
          <button class="btn-primary" 
                  (click)="proceedWithPayment()" 
                  [disabled]="!selectedPaymentMethod || isProcessingPayment">
            <i class="bi" [ngClass]="isProcessingPayment ? 'bi-hourglass-split' : 'bi-arrow-right'"></i>
            {{ isProcessingPayment ? 'payment.processing' : 'payment.proceed' | translate }}
          </button>
        </div>
      </div>
    </div>

    <!-- Bank Transfer Details Modal -->
    <div class="payment-method-modal" *ngIf="showBankTransferModal" (click)="$event.stopPropagation()">
      <div class="payment-modal-content" (click)="$event.stopPropagation()">
        <div class="payment-modal-header">
          <h3>{{ 'payment.bankTransferDetails' | translate }}</h3>
          <button class="modal-close-btn" (click)="closeBankTransferModal()">
            <i class="bi bi-x"></i>
          </button>
        </div>
        
        <div class="payment-modal-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            {{ 'payment.bankTransferInstructions' | translate }}
          </div>

          <div class="payment-summary">
            <h5>{{ 'payment.transferDetails' | translate }}</h5>
            
            <div class="bank-details" *ngIf="bankTransferDetails">
              <div class="detail-item">
                <span>{{ 'payment.bankName' | translate }}:</span>
                <span>{{ bankTransferDetails.bankName }}</span>
                <button class="btn-copy" (click)="copyToClipboard(bankTransferDetails.bankName)">
                  <i class="bi bi-clipboard"></i>
                </button>
              </div>
              
              <div class="detail-item">
                <span>{{ 'payment.accountNumber' | translate }}:</span>
                <span>{{ bankTransferDetails.accountNumber }}</span>
                <button class="btn-copy" (click)="copyToClipboard(bankTransferDetails.accountNumber)">
                  <i class="bi bi-clipboard"></i>
                </button>
              </div>
              
              <div class="detail-item">
                <span>{{ 'payment.routingNumber' | translate }}:</span>
                <span>{{ bankTransferDetails.routingNumber }}</span>
                <button class="btn-copy" (click)="copyToClipboard(bankTransferDetails.routingNumber)">
                  <i class="bi bi-clipboard"></i>
                </button>
              </div>
              
              <div class="detail-item">
                <span>{{ 'payment.reference' | translate }}:</span>
                <span class="reference-number">{{ bankTransferReference }}</span>
                <button class="btn-copy" (click)="copyToClipboard(bankTransferReference)">
                  <i class="bi bi-clipboard"></i>
                </button>
              </div>
              
              <div class="detail-item total">
                <span>{{ 'payment.amount' | translate }}:</span>
                <span class="total-price">${{ calculatedPrice.toFixed(2) }}</span>
              </div>
            </div>
          </div>

          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            {{ 'payment.includeReference' | translate }}
          </div>
        </div>

        <div class="payment-modal-footer">
          <button class="btn-secondary" (click)="closeBankTransferModal()">
            {{ 'payment.close' | translate }}
          </button>
          <button class="btn-primary" (click)="confirmBankTransferPayment()">
            <i class="bi bi-check-circle me-1"></i>
            {{ 'payment.confirmTransfer' | translate }}
          </button>
        </div>
      </div>
    </div>

    <!-- Payment Processing Modal -->
    <div class="payment-processing-modal" *ngIf="showPaymentProcessing" (click)="$event.stopPropagation()">
      <div class="processing-modal-content">
        <div class="processing-header">
          <h3>{{ 'payment.processing' | translate }}</h3>
        </div>
        
        <div class="processing-body">
          <div class="processing-spinner">
            <i class="bi bi-hourglass-split"></i>
          </div>
          <h5>{{ 'payment.preparingPayment' | translate }}</h5>
          <p>{{ 'payment.redirectingToPaypal' | translate }}</p>
          
          <div class="payment-details">
            <div class="detail-item">
              <span>{{ 'payment.amount' | translate }}:</span>
              <span>${{ calculatedPrice.toFixed(2) }}</span>
            </div>
            <div class="detail-item" *ngIf="actionId">
              <span>{{ 'payment.actionId' | translate }}:</span>
              <span>#{{ actionId }}</span>
            </div>
          </div>

          <div class="payment-error" *ngIf="paymentError">
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>
              {{ paymentError }}
              <button class="btn-retry-payment" (click)="retryPayment()">
                <i class="bi bi-arrow-clockwise me-1"></i>
                {{ 'payment.retry' | translate }}
              </button>
            </div>
          </div>

          <!-- For testing purposes -->
          <div class="test-section" *ngIf="actionId && paymentError">
            <button class="btn-test-payment" (click)="testPaymentSuccess()">
              <i class="bi bi-play-circle me-1"></i>
              Test Payment Success
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Generation Progress Modal -->
    <div class="generation-progress-modal" *ngIf="showGenerationProgress" (click)="$event.stopPropagation()">
      <div class="progress-modal-content">
        <div class="progress-header">
          <h3>{{ 'generation.generating' | translate }}</h3>
        </div>
        
        <div class="progress-body">
          <div class="generation-status">
            <div class="status-icon">
              <i class="bi bi-mic-fill"></i>
            </div>
            <h4>{{ 'generation.creatingAudio' | translate }}</h4>
            <p>{{ 'generation.pleaseWait' | translate }}</p>
          </div>

          <div class="generation-progress">
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="generationProgress"></div>
            </div>
            <div class="progress-text">{{ generationProgress }}%</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
