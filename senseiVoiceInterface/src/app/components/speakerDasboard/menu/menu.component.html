<!-- Header -->
<header class="topbar">
  <!-- Removed CGV Modal -->
  <div class="header-container">
    <!-- Left Section: Toggle & Title -->
    <div class="header-left">
      <!-- Home Button -->
      <button class="home-btn" 
              routerLink=""
              [attr.aria-label]="'header.navigation.home' | translate">
        <i class="bi bi-house-fill"></i>
      </button>

      <div class="page-title">
        <h1>{{ 'header.title' | translate }}</h1>
        <div class="breadcrumb">
          <span>{{ 'header.breadcrumb.home' | translate }}</span>
          <i class="bi bi-chevron-right separator"></i>
          <span class="current">{{ 'header.breadcrumb.dashboard' | translate }}</span>
        </div>
      </div>
    </div>

    <!-- Right Section: Actions & Profile -->
    <div class="header-right">
      <!-- Search -->
      <div class="search-container d-none d-lg-flex">
        <div class="search-box">
          <i class="bi bi-search search-icon"></i>
          <input 
            type="text" 
            [placeholder]="'header.search.placeholder' | translate" 
            class="search-input"
            #searchInput
            (keyup.enter)="onSearchSubmit(searchInput.value)">
        </div>
      </div>

      <!-- Balance Display -->
      <div class="balance-container">
        <div class="dropdown">
          <button 
            class="balance-button" 
            type="button" 
            id="balanceDropdown" 
            data-bs-toggle="dropdown" 
            aria-expanded="false"
            [attr.aria-label]="'header.balance.button' | translate"
            [class]="getBalanceStatusClass()">
            <div class="balance-icon">
              <i class="bi bi-wallet2"></i>
              <span class="balance-loading" *ngIf="isLoadingBalance">
                <i class="bi bi-hourglass-split"></i>
              </span>
            </div>
            <div class="balance-info d-none d-md-block">
              <span class="balance-label">{{ 'header.balance.label' | translate }}</span>
              <span class="balance-amount" *ngIf="!isLoadingBalance && !balanceError">
                {{ formatBalance(userBalance) }}
              </span>
              <span class="balance-error" *ngIf="balanceError">
                {{ 'header.balance.error' | translate }}
              </span>
              <span class="balance-loading-text" *ngIf="isLoadingBalance">
                {{ 'header.balance.loading' | translate }}
              </span>
            </div>
            <i class="bi bi-chevron-down balance-arrow d-none d-md-block"></i>
          </button>

          <div class="dropdown-menu dropdown-menu-end balance-dropdown" aria-labelledby="balanceDropdown">
            <div class="balance-dropdown-header">
              <h6>{{ 'header.balance.title' | translate }}</h6>
              <button class="balance-refresh-btn" 
                      (click)="refreshBalance()" 
                      [disabled]="isLoadingBalance"
                      [attr.title]="'header.balance.refresh' | translate">
                <i class="bi" [ngClass]="isLoadingBalance ? 'bi-hourglass-split' : 'bi-arrow-clockwise'"></i>
              </button>
            </div>

            <div class="balance-dropdown-body">
              <!-- Current Balance -->
              <div class="balance-item">
                <div class="balance-item-icon" [class]="getBalanceStatusClass()">
                  <i class="bi bi-wallet2"></i>
                </div>
                <div class="balance-item-content">
                  <h6>{{ 'header.balance.current' | translate }}</h6>
                  <p class="balance-value" *ngIf="!isLoadingBalance && !balanceError">
                    {{ formatBalance(userBalance) }}
                  </p>
                  <p class="balance-status" *ngIf="!isLoadingBalance && !balanceError">
                    {{ getBalanceStatusText() | translate }}
                  </p>
                  <p class="balance-error-text" *ngIf="balanceError">
                    {{ balanceError }}
                  </p>
                  <p class="balance-loading-text" *ngIf="isLoadingBalance">
                    <i class="bi bi-hourglass-split me-1"></i>
                    {{ 'header.balance.loading' | translate }}
                  </p>
                </div>
              </div>

              <!-- Balance Actions -->
              <div class="balance-actions" *ngIf="!isLoadingBalance">
                <button class="balance-action-btn primary" (click)="showAddFundsModal()">
                  <i class="bi bi-plus-circle me-1"></i>
                  {{ 'header.balance.addFunds' | translate }}
                </button>
              </div>

              <!-- Low Balance Warning -->
              <div class="balance-warning" *ngIf="userBalance < 50 && !isLoadingBalance">
                <div class="alert alert-warning">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  <div>
                    <strong>{{ 'header.balance.warning.title' | translate }}</strong>
                    <p>{{ 'header.balance.warning.message' | translate }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Balance Charge Modal -->
      <div class="payment-method-modal" *ngIf="showBalanceChargeModal" (click)="closeBalanceChargeModal()">
        <div class="payment-modal-content" (click)="$event.stopPropagation()">
          <div class="payment-modal-header">
            <h3>{{ 'header.balance.addFunds' | translate }}</h3>
            <button class="modal-close-btn" (click)="closeBalanceChargeModal()">
              <i class="bi bi-x"></i>
            </button>
          </div>
          
          <div class="payment-modal-body">
            <!-- Charge Amount Section -->
            <div class="charge-amount-section">
              <label for="chargeAmount">{{ 'header.balance.chargeAmount' | translate }}:</label>
              <div class="charge-input-group">
                <span class="currency-symbol">MAD</span>
                <input type="number" 
                       id="chargeAmount"
                       class="charge-amount-input"
                       [value]="chargeAmount"
                       (input)="onChargeAmountChange($event)"
                       (blur)="onChargeAmountBlur($event)"
                       [min]="getMinimumChargeAmount()"
                       step="0.01"
                       placeholder="0.00">
              </div>
              <small class="charge-hint">
                {{ 'header.balance.minimumCharge' | translate }}: {{ getMinimumChargeAmount() }} MAD
              </small>
            </div>

            <!-- Charge Methods -->
            <div class="payment-methods">
              <h5>{{ 'header.balance.selectChargeMethod' | translate }}</h5>
              
              <!-- PayPal Charge -->
              <div class="payment-method-option" 
                   [class.selected]="selectedChargeMethod === 'paypal'"
                   (click)="selectChargeMethod('paypal')">
                <div class="payment-method-icon">
                  <i class="bi bi-paypal"></i>
                </div>
                <div class="payment-method-info">
                  <h6>PayPal</h6>
                  <p>{{ 'header.balance.chargeWithPaypal' | translate }}</p>
                </div>
                <div class="payment-method-check" *ngIf="selectedChargeMethod === 'paypal'">
                  <i class="bi bi-check-circle-fill"></i>
                </div>
              </div>

              <!-- Credit Card Charge -->
              <div class="payment-method-option" 
                   [class.selected]="selectedChargeMethod === 'card'"
                   (click)="selectChargeMethod('card')">
                <div class="payment-method-icon">
                  <i class="bi bi-credit-card"></i>
                </div>
                <div class="payment-method-info">
                  <h6>{{ 'header.balance.creditCard' | translate }}</h6>
                  <p>{{ 'header.balance.chargeWithCard' | translate }}</p>
                </div>
                <div class="payment-method-check" *ngIf="selectedChargeMethod === 'card'">
                  <i class="bi bi-check-circle-fill"></i>
                </div>
              </div>

              <!-- Bank Transfer Charge -->
              <div class="payment-method-option" 
                   [class.selected]="selectedChargeMethod === 'verment'"
                   (click)="selectChargeMethod('verment')">
                <div class="payment-method-icon">
                  <i class="bi bi-bank"></i>
                </div>
                <div class="payment-method-info">
                  <h6>{{ 'header.balance.bankTransfer' | translate }}</h6>
                  <p>{{ 'header.balance.chargeWithBank' | translate }}</p>
                </div>
                <div class="payment-method-check" *ngIf="selectedChargeMethod === 'verment'">
                  <i class="bi bi-check-circle-fill"></i>
                </div>
              </div>
            </div>

            <!-- Error Display -->
            <div class="charge-error" *ngIf="chargeError">
              <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                {{ chargeError }}
              </div>
            </div>
          </div>

          <div class="payment-modal-footer">
            <button class="btn-secondary" (click)="closeBalanceChargeModal()">
              {{ 'header.balance.cancel' | translate }}
            </button>
            <button class="btn-primary" 
                    (click)="proceedWithBalanceCharge()" 
                    [disabled]="!selectedChargeMethod || isChargingBalance || chargeAmount <= 0">
              <i class="bi" [ngClass]="isChargingBalance ? 'bi-hourglass-split' : 'bi-arrow-right'"></i>
              {{ isChargingBalance ? 'header.balance.processing' : 'header.balance.chargeNow' | translate }}
            </button>
          </div>
        </div>
      </div>

      <!-- Payment Processing Modal -->
      <div class="payment-processing-modal" *ngIf="showPaymentProcessing" (click)="$event.stopPropagation()">
        <div class="processing-modal-content">
          <div class="processing-header">
            <h3>{{ 'header.balance.processing' | translate }}</h3>
          </div>
          
          <div class="processing-body">
            <div class="processing-spinner">
              <i class="bi bi-hourglass-split"></i>
            </div>
            <h5>{{ 'header.balance.preparingPayment' | translate }}</h5>
            <p>{{ 'header.balance.redirectingToPaypal' | translate }}</p>
            
            <div class="payment-details">
              <div class="detail-item">
                <span>{{ 'header.balance.amount' | translate }}:</span>
                <span>{{ chargeAmount }} MAD</span>
              </div>
            </div>

            <div class="payment-error" *ngIf="chargeError">
              <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                {{ chargeError }}
                <button class="btn-retry-payment" (click)="retryBalanceCharge()">
                  <i class="bi bi-arrow-clockwise me-1"></i>
                  {{ 'header.balance.retry' | translate }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Language Selector -->
      <div class="language-selector">
        <div class="dropdown">
          <button 
            class="language-button" 
            type="button" 
            id="languageDropdown" 
            data-bs-toggle="dropdown" 
            aria-expanded="false"
            [attr.aria-label]="'header.language.selector' | translate">
            <i class="bi bi-globe"></i>
            <span>{{ getLanguageDisplayName() }}</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="languageDropdown">
            <li>
              <a class="dropdown-item" 
                 href="#" 
                 (click)="changeLanguage('en'); $event.preventDefault()"
                 [class.active]="getCurrentLanguage() === 'en'">
                <span class="language-flag">🇺🇸</span> 
                {{ 'header.language.options.english' | translate }}
              </a>
            </li>
            <li>
              <a class="dropdown-item" 
                 href="#" 
                 (click)="changeLanguage('fr'); $event.preventDefault()"
                 [class.active]="getCurrentLanguage() === 'fr'">
                <span class="language-flag">🇫🇷</span> 
                {{ 'header.language.options.french' | translate }}
              </a>
            </li>
            <li>
              <a class="dropdown-item" 
                 href="#" 
                 (click)="changeLanguage('es'); $event.preventDefault()"
                 [class.active]="getCurrentLanguage() === 'es'">
                <span class="language-flag">🇪🇸</span> 
                {{ 'header.language.options.spanish' | translate }}
              </a>
            </li>

            <!-- Corrected Code -->
<li>
  <a class="dropdown-item" 
     href="#" 
     (click)="changeLanguage('ar'); $event.preventDefault()"
     [class.active]="getCurrentLanguage() === 'ar'">
    <span class="language-flag">🇸🇦</span> <!-- Optional: Changed to a flag for consistency -->
    {{ 'header.language.options.arabic' | translate }}
  </a>
</li>
          </ul>
        </div>
      </div>

      <!-- Notifications - Updated to use real data -->
      <div class="notification-container">
        <div class="dropdown">
          <button 
            class="notification-button" 
            id="notificationsDropdown" 
            data-bs-toggle="dropdown" 
            aria-expanded="false"
            [attr.aria-label]="'header.notifications.button' | translate">
            <i class="bi bi-bell" [class.text-muted]="isLoadingNotifications"></i>
            <span class="notification-badge" *ngIf="notificationCount > 0">{{ notificationCount }}</span>
            <!-- Loading indicator -->
            <span class="notification-loading" *ngIf="isLoadingNotifications">
              <i class="bi bi-hourglass-split"></i>
            </span>
          </button>
          <div class="dropdown-menu dropdown-menu-end notification-dropdown" aria-labelledby="notificationsDropdown">
            <div class="notification-header">
              <h6>{{ 'header.notifications.title' | translate }}</h6>
              <div class="notification-actions">
                <button class="refresh-notifications-btn" 
                        (click)="refreshNotifications()" 
                        [disabled]="isLoadingNotifications"
                        [attr.title]="'Refresh notifications'">
                  <i class="bi" [ngClass]="isLoadingNotifications ? 'bi-hourglass-split' : 'bi-arrow-clockwise'"></i>
                </button>
                <a href="#" 
                   class="mark-all" 
                   (click)="markAllNotificationsAsRead(); $event.preventDefault()"
                   *ngIf="notificationCount > 0">
                  {{ 'header.notifications.markAllRead' | translate }}
                </a>
              </div>
            </div>
            <div class="notification-body">
              <!-- Loading State -->
              <div *ngIf="isLoadingNotifications" class="notification-loading-state">
                <div class="loading-spinner">
                  <i class="bi bi-hourglass-split"></i>
                </div>
                <p>{{ 'Loading notifications...' | translate }}</p>
              </div>

              <!-- Error State -->
              <div *ngIf="notificationError && !isLoadingNotifications" class="notification-error-state">
                <div class="error-icon">
                  <i class="bi bi-exclamation-triangle"></i>
                </div>
                <p>{{ notificationError }}</p>
                <button class="btn-retry" (click)="refreshNotifications()">
                  <i class="bi bi-arrow-clockwise me-1"></i>
                  {{ 'Retry' | translate }}
                </button>
              </div>

              <!-- Empty State -->
              <div *ngIf="!isLoadingNotifications && !notificationError && notifications.length === 0" class="no-notifications">
                <div class="empty-icon">
                  <i class="bi bi-bell-slash"></i>
                </div>
                <p>{{ 'header.notifications.noNotifications' | translate }}</p>
              </div>

              <!-- Notifications List -->
              <div *ngIf="!isLoadingNotifications && !notificationError && notifications.length > 0">
                <a routerLink="requests" 
                   class="notification-item" 
                   *ngFor="let notification of notifications; trackBy: trackNotificationById"
                   [class.unread]="!notification.readAt"
                   (click)="handleNotificationAction(notification); $event.preventDefault()">
                  <div class="notification-icon">
                    <i [class]="getNotificationIcon(notification.type)"></i>
                  </div>
                  <div class="notification-content">
                    <div class="notification-header-item">
                      <p class="notification-title">{{ notification.title }}</p>
                      <button class="notification-delete-btn" 
                              (click)="deleteNotification(notification.id); $event.stopPropagation()"
                              [attr.title]="'Delete notification'">
                        <i class="bi bi-x"></i>
                      </button>
                    </div>
                    <p class="notification-text">{{ notification.message }}</p>
                    <div class="notification-meta">
                      <span class="notification-time">{{ formatNotificationTime(notification.createdAt) }}</span>
                      <span class="notification-sender" *ngIf="notification.senderName">
                        {{ 'from' | translate }} {{ notification.senderName }}
                      </span>
                      <span class="notification-type-badge" [class]="'type-' + notification.type.toLowerCase()">
                        {{ notification.type | titlecase }}
                      </span>
                    </div>
                  </div>
                  <div class="notification-status" *ngIf="!notification.readAt">
                    <span class="unread-indicator"></span>
                  </div>
                </a>
              </div>
            </div>
            <div class="notification-footer" *ngIf="notifications.length > 0">
              <a href="#" 
                 class="view-all" 
                 (click)="navigateToNotifications(); $event.preventDefault()">
                {{ 'header.notifications.viewAll' | translate }}
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- User Profile -->
      <div class="profile-container">
        <div class="dropdown">
          <button 
            class="profile-button" 
            id="userDropdown" 
            data-bs-toggle="dropdown" 
            aria-expanded="false"
            [attr.aria-label]="'header.profile.menu' | translate">
            <div class="profile-avatar">
              <img 
                [src]="userPhotoUrl || 'assets/img/png-clipart-computer-icons-avatar-avatar-web-design-heroes.png'" 
                [alt]="'header.profile.avatar' | translate">
              <span class="status-indicator" [attr.title]="'header.profile.status.online' | translate"></span>
            </div>
            <div class="profile-info d-none d-md-block">
              <h6 class="profile-name">{{ speaker?.prenom }} {{ speaker?.nom }}</h6>
              <p class="profile-role">{{ speaker?.code }}</p>
            </div>
            <i class="bi bi-chevron-down profile-arrow"></i>
          </button>

          <div class="dropdown-menu dropdown-menu-end profile-dropdown" aria-labelledby="userDropdown">
            <div class="dropdown-header">
              <h6>{{ speaker?.prenom }} {{ speaker?.nom }}</h6>
              <p>{{ speaker?.code }}</p>
            </div>

            <div class="dropdown-body">
              <a class="dropdown-item" 
                 routerLink="setting"
                 (click)="navigateToSettings()">
                <i class="bi bi-gear"></i>
                <span>{{ 'header.profile.menu.accountSettings' | translate }}</span>
              </a>
            </div>

            <div class="dropdown-footer">
              <a class="dropdown-item logout-item" 
                 href="#" 
                 (click)="logout(); $event.preventDefault()">
                <i class="bi bi-box-arrow-right"></i>
                <span>{{ 'header.profile.menu.logout' | translate }}</span>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>
