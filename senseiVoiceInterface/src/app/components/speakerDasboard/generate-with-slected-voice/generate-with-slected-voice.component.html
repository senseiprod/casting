<div class="main-container">
  <div class="content">
    <!-- Voice Showcase Section (when voice is selected) -->
    <div *ngIf="selectedVoice && !showVoiceSelection" class="voice-showcase-container">
      <!-- Voice Hero Section -->
      <div class="voice-hero-card">
        <div class="voice-hero-content">
          <div class="voice-avatar-section">
            <div class="voice-avatar-large">
              <img [src]="selectedVoice.avatar || getVoiceProfileImage(selectedVoice)" 
                   alt="{{ selectedVoice.name }}" 
                   class="avatar-image">
            </div>
            <div class="voice-status-indicator"></div>
          </div>
          
          <div class="voice-info-section">
            <div class="voice-header">
              <h1 class="voice-name">{{ selectedVoice.name }}</h1>
              <button class="favorite-btn" title="Add to favorites">
                <i class="bi bi-heart"></i>
              </button>
            </div>
            
            <div class="voice-badges">
              <span class="badge badge-type">{{ selectedVoice.type }}</span>
              <span class="badge badge-language">{{ selectedVoice.language }}</span>
              <span class="badge badge-gender">{{ selectedVoice.gender }}</span>
              <span class="badge badge-age">{{ selectedVoice.ageZone }}</span>
            </div>
            
            <div class="voice-description">
              <p>{{ 'voiceShowcase.description' | translate }}</p>
            </div>
          </div>
          
          <div class="voice-actions-section">
            <button class="btn-change-voice" (click)="toggleVoiceSelection()">
              <i class="bi bi-arrow-left me-2"></i>
              {{ 'voiceShowcase.changeVoice' | translate }}
            </button>
          </div>
        </div>
      </div>

      <!-- Voice Preview Section -->
      <div class="voice-preview-section">
        <div class="preview-card">
          <h3 class="preview-title">{{ 'voiceShowcase.voicePreview' | translate }}</h3>
          <div class="preview-controls">
            <button class="preview-btn original" (click)="playVoice(selectedVoice)">
              <i *ngIf="currentPlayingVoiceId !== selectedVoice.id" class="bi bi-play-fill"></i>
              <i *ngIf="currentPlayingVoiceId === selectedVoice.id" class="bi bi-pause-fill"></i>
              {{ 'voiceSelection.buttons.original' | translate }}
            </button>
            <button class="preview-btn cloned" (click)="playClonedVoice(selectedVoice)">
              <i class="bi bi-play-fill"></i>
              {{ 'voiceSelection.buttons.cloned' | translate }}
            </button>
          </div>
        </div>
        
        <div class="voice-specs-card">
          <h3 class="specs-title">{{ 'voiceSelection.filters.specifications' | translate }}</h3>
          <div class="specs-grid">
            <div class="spec-item">
              <span class="spec-label">{{ 'voiceSelection.filters.language' | translate }}</span>
              <span class="spec-value">{{ selectedVoice.language }}</span>
              <span class="spec-label">{{ 'voiceSelection.filters.gender' | translate }}</span>
              <span class="spec-value">{{ selectedVoice.gender }}</span>
            </div>
            <div class="spec-item">
              <span class="spec-label">{{ 'voiceSelection.filters.ageGroup' | translate }}</span>
              <span class="spec-value">{{ selectedVoice.ageZone }}</span>
              <span class="spec-label">{{ 'voiceSelection.filters.type' | translate }}</span>
              <span class="spec-value">{{ selectedVoice.type }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Generation Tabs -->
      <div class="generation-tabs-container">
        <div class="tabs-header">
          <button class="tab-btn" 
                  [class.active]="activeTab === 'free'"
                  (click)="setActiveTab('free')">
            <i class="bi bi-gift me-2"></i>
            {{ 'tabs.freeTest' | translate }}
          </button>
          <button class="tab-btn" 
                  [class.active]="activeTab === 'request'"
                  (click)="setActiveTab('request')">
            <i class="bi bi-credit-card me-2"></i>
            {{ 'tabs.audioRequest' | translate }}
          </button>
        </div>

        <!-- Free Test Tab -->
        <div class="tab-content" [hidden]="activeTab !== 'free'">
          <div class="generation-card">
            <div class="generation-header">
              <h3>{{ 'generation.freeTestTitle' | translate }}</h3>
              <div class="character-counter">
                <span [class.text-danger]="isTextOverLimit()">
                  {{ actionData.text.length }}/{{ freeTestCharLimit }}
                </span>
              </div>
            </div>
            
            <div class="text-input-section">
              <textarea 
                class="generation-textarea"
                [(ngModel)]="actionData.text"
                [class.text-danger]="isTextOverLimit()"
                (input)="limitText()" 
                (ngModelChange)="checkTextLength()"
                [placeholder]="'generation.textPlaceholder' | translate">
              </textarea>
              
              <div class="input-info" *ngIf="isTextOverLimit()">
                <div class="alert alert-warning">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  {{ 'characterLimit.warning' | translate }}
                </div>
              </div>
            </div>

            <div class="generation-controls">
              <div class="project-selector" *ngIf="!showProjectSelection">
                <button class="btn-project" (click)="toggleProjectSelection()">
                  <i class="bi bi-folder2 me-2"></i>
                  {{ selectedProject ? selectedProject.name : ('projectSelection.selectProjectBtn' | translate) }}
                </button>
              </div>

              <div class="generation-actions">
                <div class="pricing-info">
                  <span class="price-label">{{ 'info.free' | translate }}</span>
                </div>
                <button class="btn-generate" 
                        (click)="generateSpeech()" 
                        [disabled]="isGenerating || !selectedVoice">
                  <i class="bi" [ngClass]="isGenerating ? 'bi-hourglass-split' : 'bi-play-fill'"></i>
                  {{ isGenerating ? ('generation.generating' | translate) : ('generation.generate' | translate) }}
                </button>
              </div>
            </div>

            <!-- Custom Audio Player -->
            <div class="custom-audio-player" *ngIf="audioUrl">
              <div class="audio-player-container">
                <div class="audio-player-header">
                  <h4 class="audio-title">{{ 'audio.generatedAudio' | translate }}</h4>
                  <div class="audio-info">
                    <span class="audio-duration">{{ formatTime(currentTime) }} / {{ formatTime(duration) }}</span>
                  </div>
                </div>
                
                <div class="audio-player-controls">
                  <button class="audio-control-btn play-pause-btn" 
                          (click)="togglePlayPause()"
                          [disabled]="!audioUrl">
                    <i class="bi" [ngClass]="isPlaying ? 'bi-pause-fill' : 'bi-play-fill'"></i>
                  </button>
                  
                  <div class="audio-progress-container">
                    <div class="audio-progress-bar" 
                         (click)="seekTo($event)"
                         #progressBar>
                      <div class="audio-progress-fill" 
                           [style.width.%]="progressPercentage"></div>
                      <div class="audio-progress-thumb" 
                           [style.left.%]="progressPercentage"></div>
                    </div>
                  </div>
                  
                  <button class="audio-control-btn volume-btn" 
                          (click)="toggleMute()">
                    <i class="bi" [ngClass]="isMuted ? 'bi-volume-mute-fill' : 'bi-volume-up-fill'"></i>
                  </button>
                  
                  <div class="volume-control">
                    <input type="range" 
                           class="volume-slider"
                           min="0" 
                           max="100" 
                           [(ngModel)]="volume"
                           (input)="setVolume($event)">
                  </div>
                </div>
                
                <div class="audio-waveform">
                  <div class="waveform-bars">
                    <div class="waveform-bar" 
                         *ngFor="let bar of waveformBars; let i = index"
                         [style.height.%]="bar"
                         [class.active]="i < (progressPercentage / 100 * waveformBars.length)">
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Hidden audio element for playback control -->
              <audio #audioElement
                     [src]="audioUrl"
                     (loadedmetadata)="onAudioLoaded()"
                     (timeupdate)="onTimeUpdate()"
                     (ended)="onAudioEnded()"
                     preload="metadata"
                     style="display: none;">
              </audio>
            </div>

            <!-- Status Messages -->
            <div class="status-messages" *ngIf="generationSuccess || generationError">
              <div class="alert alert-success" *ngIf="generationSuccess">
                <i class="bi bi-check-circle me-2"></i>
                {{ 'generation.success' | translate }}
                <span *ngIf="selectedProject">{{ 'generation.andSavedTo' | translate }} "{{ selectedProject.name }}"</span>!
              </div>
              <div class="alert alert-danger" *ngIf="generationError">
                <i class="bi bi-exclamation-triangle me-2"></i>
                {{ generationError }}
              </div>
            </div>
          </div>
        </div>

        <!-- Audio Request Tab -->
        <div class="tab-content" [hidden]="activeTab !== 'request'">
          <div class="generation-card">
            <div class="generation-header">
              <h3>{{ 'generation.audioRequestTitle' | translate }}</h3>
              <div class="character-counter">
                <span>{{ actionData.text.length }} {{ 'info.characters' | translate }}</span>
              </div>
            </div>
            
            <div class="text-input-section">
              <textarea 
                class="generation-textarea"
                [(ngModel)]="actionData.text"
                [placeholder]="'generation.textPlaceholderPaid' | translate">
              </textarea>
            </div>

            <div class="pricing-breakdown">
              <div class="pricing-card">
                <h4>{{ 'checkout.pricingInformation' | translate }}</h4>
                <div class="pricing-details">
                  <div class="pricing-row">
                    <span>{{ 'checkout.pricePerCharacter' | translate }}</span>
                    <span class="price-value">${{ price }}</span>
                  </div>
                  <div class="pricing-row">
                    <span>{{ 'checkout.totalCharacters' | translate }}</span>
                    <span class="char-count">{{ actionData.text.length }}</span>
                  </div>
                  <div class="pricing-row total">
                    <span>{{ 'checkout.totalPrice' | translate }}</span>
                    <span class="total-price">${{ price * actionData.text.length }}</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="generation-controls">
              <button class="btn-checkout" 
                      (click)="generateSpeech()" 
                      [disabled]="!selectedVoice || actionData.text.length === 0">
                <i class="bi bi-cart me-2"></i>
                {{ 'checkout.proceedToCheckout' | translate }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Voice Selection Section (when no voice selected or browsing) -->
    <div *ngIf="showVoiceSelection" class="voice-selection-container">
      <div class="selection-header">
        <h2 style="margin-left: 10px;">{{ 'voiceSelection.title' | translate }}</h2>
        <button class="btn-close-selection" (click)="closeModal()" *ngIf="selectedVoice">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <!-- Filters -->
      <div class="filters-section">
        <div class="filters-grid">
          <input type="text" 
                 class="filter-input" 
                 [placeholder]="'voiceSelection.searchPlaceholder' | translate" 
                 [(ngModel)]="filters.search" 
                 (input)="applyFilters()">
          
          <select class="filter-select" [(ngModel)]="filters.type" (change)="applyFilters()">
            <option value="">{{ 'voiceSelection.filters.allTypes' | translate }}</option>
            <option value="premade">{{ 'voiceSelection.filters.ai' | translate }}</option>
            <option value="professional">{{ 'voiceSelection.filters.cloned' | translate }}</option>
          </select>
          
          <select class="filter-select" [(ngModel)]="filters.language" (change)="applyFilters()">
            <option value="">{{ 'voiceSelection.filters.allLanguages' | translate }}</option>
            <option *ngFor="let lang of languages" [value]="lang.code">
              {{ lang.name }}
            </option>
          </select>
          
          
          <select class="filter-select" [(ngModel)]="filters.gender" (change)="applyFilters()">
            <option value="">{{ 'voiceSelection.filters.allGenders' | translate }}</option>
            <option value="male">{{ 'voiceSelection.filters.male' | translate }}</option>
            <option value="female">{{ 'voiceSelection.filters.female' | translate }}</option>
          </select>
          
          <select class="filter-select" [(ngModel)]="filters.ageZone" (change)="applyFilters()">
            <option value="">{{ 'voiceSelection.filters.allAges' | translate }}</option>
            <option value="young">{{ 'voiceSelection.filters.young' | translate }}</option>
            <option value="middle_aged">{{ 'voiceSelection.filters.adult' | translate }}</option>
            <option value="old">{{ 'voiceSelection.filters.senior' | translate }}</option>
          </select>
          
          <button class="btn-reset-filters" (click)="resetFilters()">
            {{ 'voiceSelection.filters.resetAll' | translate }}
          </button>
        </div>
      </div>

      <!-- Voice Grid -->
      <div class="voices-grid">
        <div class="voice-card-modern" 
             *ngFor="let voice of filteredVoices | paginate: { itemsPerPage: 6, currentPage: currentPage }"
             [class.selected]="selectedVoice && selectedVoice.id === voice.id"
             (click)="selectVoice(voice)">
          
          <div class="voice-card-header">
            <div class="voice-avatar-small">
              <img [src]="voice.avatar || getVoiceProfileImage(voice)" alt="{{ voice.name }}">
            </div>
            <button class="voice-favorite">
              <i class="bi bi-heart"></i>
            </button>
          </div>
          
          <div class="voice-card-body">
            <h4 class="voice-card-name">{{ voice.name }}</h4>
            <div class="voice-card-badges">
              <span class="mini-badge">{{ voice.type }}</span>
              <span class="mini-badge">{{ voice.language }}</span>
            </div>
            <p class="voice-card-details">{{ voice.gender }} â€¢ {{ voice.ageZone }}</p>
          </div>
          
          <div class="voice-card-actions">
          
            <div class="btn-preview play-button " (click)="playVoice(voice) ; $event.stopPropagation();">
              <i *ngIf="currentPlayingVoiceId !== voice.id" class="bi bi-play-fill"></i>
              <i *ngIf="currentPlayingVoiceId === voice.id" class="bi bi-pause-fill"></i>
            </div>
            <button class="btn-select" (click)="selectVoice(voice); closeModal(); $event.stopPropagation();">
              {{ 'voiceSelection.buttons.useVoice' | translate }}
            </button>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div class="pagination-section">
        <pagination-controls (pageChange)="currentPage = $event"></pagination-controls>
      </div>
    </div>

    <!-- Project Selection Modal -->
    <div class="project-modal" *ngIf="showProjectSelection">
      <div class="project-modal-content">
        <div class="project-modal-header">
          <h3>{{ 'projectSelection.title' | translate }}</h3>
          <button class="btn-close" (click)="toggleProjectSelection()">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        
        <div class="project-modal-body">
          <div class="alert alert-info" *ngIf="projects.length === 0">
            <i class="bi bi-info-circle me-2"></i>
            {{ 'projectSelection.noProjects' | translate }}
          </div>
          
          <div class="projects-list" *ngIf="projects.length > 0">
            <div class="project-item" 
                 *ngFor="let project of projects"
                 [class.selected]="selectedProject && selectedProject.uuid === project.uuid"
                 (click)="selectProject(project)">
              <div class="project-info">
                <h4>{{ project.name }}</h4>
                <small>{{ project.dateCreation | date }}</small>
              </div>
              <div class="project-select" *ngIf="selectedProject && selectedProject.uuid === project.uuid">
                <i class="bi bi-check-circle"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="project-modal-backdrop" (click)="toggleProjectSelection()"></div>
    </div>

    <!-- Character Limit Modal -->
    <div class="char-limit-modal" *ngIf="showCharLimitModal">
      <div class="char-limit-modal-content">
        <div class="char-limit-header">
          <h3>{{ 'charLimit.title' | translate }}</h3>
          <button class="btn-close" (click)="cancelExceedLimit()">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        
        <div class="char-limit-body">
          <p>{{ 'charLimit.message' | translate }}</p>
          <p class="text-danger">{{ 'charLimit.paidNotice' | translate }}</p>
          
          <div class="char-limit-breakdown">
            <div class="breakdown-item">
              <span>{{ 'charLimit.freeChars' | translate }}:</span>
              <span>100</span>
            </div>
            <div class="breakdown-item">
              <span>{{ 'charLimit.yourChars' | translate }}:</span>
              <span>{{ actionData.text.length }}</span>
            </div>
            <div class="breakdown-item">
              <span>{{ 'charLimit.paidChars' | translate }}:</span>
              <span>{{ actionData.text.length - 100 }}</span>
            </div>
            <div class="breakdown-item total">
              <span>{{ 'charLimit.estimatedCost' | translate }}:</span>
              <span>${{ price * (actionData.text.length - 100) }}</span>
            </div>
          </div>
        </div>
        
        <div class="char-limit-actions">
          <button class="btn-secondary" (click)="cancelExceedLimit()">
            {{ 'charLimit.cancel' | translate }}
          </button>
          <button class="btn-primary" (click)="acceptExceedLimit()">
            {{ 'charLimit.continue' | translate }}
          </button>
        </div>
      </div>
      <div class="char-limit-backdrop" (click)="cancelExceedLimit()"></div>
    </div>
  </div>
</div>
