<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SenseiVoix Backend Logic Test Page</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background-color: #f4f7f9; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h1, h2 { color: #2c3e50; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        .panel { border: 1px solid #ccc; padding: 20px; margin-bottom: 25px; border-radius: 5px; background-color: #fdfdfd; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        input[type="text"], textarea { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        textarea { min-height: 80px; resize: vertical; }
        button { background-color: #3498db; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px; margin-bottom: 10px; transition: background-color 0.3s; }
        button:hover { background-color: #2980b9; }
        button.admin-btn { background-color: #e67e22; }
        button.admin-btn:hover { background-color: #d35400; }
        #log { background-color: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 4px; height: 400px; overflow-y: scroll; white-space: pre-wrap; font-family: "Courier New", Courier, monospace; font-size: 14px; }
        .log-entry { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dotted #4a617a; }
        .log-req { color: #f1c40f; }
        .log-res { color: #2ecc71; }
        .log-info { color: #3498db; }
        .log-error { color: #e74c3c; font-weight: bold; }
        .download-link { display: inline-block; background-color: #27ae60; color: white !important; padding: 8px 12px; text-decoration: none; border-radius: 4px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>SenseiVoix Logic Test Bench</h1>
    <p>This page tests the end-to-end action creation, payment, and audio generation flow, including the new speaker earnings logic.</p>

    <div class="panel" id="config-panel">
        <h2>Configuration</h2>
        <label for="backendUrl">Backend URL</label>
        <input type="text" id="backendUrl" value="https://api.castingvoixoff.ma">

        <label for="userUuid">Utilisateur UUID</label>
        <input type="text" id="userUuid" value="your-user-uuid-here">

        <label for="projectUuid">Project UUID (Optional)</label>
        <input type="text" id="projectUuid" value="your-project-uuid-here">
    </div>

    <div class="panel">
        <h2>1. Standard (ElevenLabs) TTS Workflow</h2>
        <label for="textStandard">Text to Generate</label>
        <textarea id="textStandard">Hello world, this is a test of the text to speech system.</textarea>

        <label for="unmanagedVoiceId">Unmanaged Voice ID (No Speaker Earnings)</label>
        <input type="text" id="unmanagedVoiceId" value="21m00Tcm4TlvDq8ikWAM">

        <label for="managedVoiceId">Managed Voice ID (Triggers Speaker Earnings)</label>
        <input type="text" id="managedVoiceId" value="your-managed-voix2-elevenlabs-id-here">

        <button onclick="runTest('unmanaged', 'paypal', 'standard')">Test Unmanaged (PayPal)</button>
        <button onclick="runTest('managed', 'paypal', 'standard')">Test Managed (PayPal)</button>
        <button onclick="runTest('managed', 'bank', 'standard')">Test Managed (Bank Transfer)</button>
    </div>

    <div class="panel">
        <h2>2. Lahajati TTS Workflow</h2>
        <label for="textLahajati">Text to Generate</label>
        <textarea id="textLahajati">Marhaban, hada ikhtibar li nidaam tahwil an-nas ila sawt.</textarea>

        <label for="lahajatiVoiceId">Lahajati Managed Voice ID</label>
        <input type="text" id="lahajatiVoiceId" value="your-lahajati-managed-id-here">

        <button onclick="runTest('lahajati_managed', 'paypal', 'lahajati')">Test Lahajati (PayPal)</button>
        <button onclick="runTest('lahajati_managed', 'bank', 'lahajati')">Test Lahajati (Bank Transfer)</button>
    </div>

    <div class="panel">
        <h2>3. Admin Panel (For Bank Transfer Validation)</h2>
        <label for="actionIdToValidate">Action ID to Validate</label>
        <input type="text" id="actionIdToValidate">
        <button class="admin-btn" onclick="validateTransfer('standard')">Validate Standard Transfer</button>
        <button class="admin-btn" onclick="validateTransfer('lahajati')">Validate Lahajati Transfer</button>
    </div>

    <div class="panel">
        <h2>4. Live Log / Results</h2>
        <div id="log"></div>
    </div>
</div>

<script>
    const logEl = document.getElementById('log');

    function logMessage(message, type = 'info', data = null) {
        const entry = document.createElement('div');
        entry.className = `log-entry log-${type}`;

        let content = `[${new Date().toLocaleTimeString()}] ${message}`;
        if (data) {
            content += `\n<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }

        entry.innerHTML = content;
        logEl.appendChild(entry);
        logEl.scrollTop = logEl.scrollHeight;
    }

    async function runTest(voiceType, paymentType, workflowType) {
        const backendUrl = document.getElementById('backendUrl').value;
        const userUuid = document.getElementById('userUuid').value;
        const projectUuid = document.getElementById('projectUuid').value;

        let voiceId, text, endpoint;
        const requestBody = {
            utilisateurUuid: userUuid,
            projectUuid: projectUuid,
            language: 'en'
        };

        if (workflowType === 'standard') {
            text = document.getElementById('textStandard').value;
            voiceId = (voiceType === 'managed')
                ? document.getElementById('managedVoiceId').value
                : document.getElementById('unmanagedVoiceId').value;
            endpoint = (paymentType === 'paypal')
                ? '/api/actions/create-action'
                : '/api/actions/create-action-bank-transfer';
        } else { // lahajati
            text = document.getElementById('textLahajati').value;
            voiceId = document.getElementById('lahajatiVoiceId').value;
            endpoint = (paymentType === 'paypal')
                ? '/api/actions/lahajati/create-action-paypal'
                : '/api/actions/lahajati/create-action-bank-transfer';
            requestBody.language = 'darija'; // Specific to lahajati
        }

        requestBody.text = text;
        requestBody.voiceUuid = voiceId;

        logMessage(`üöÄ Starting Test: ${workflowType} workflow, ${voiceType} voice, ${paymentType} payment.`, 'info');
        logMessage(`POST ${endpoint}`, 'req', requestBody);

        try {
            const response = await fetch(`${backendUrl}${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            const result = await response.json();
            logMessage(`‚úÖ Action Creation Response`, 'res', result);

            if (!response.ok) {
                throw new Error(result.error || 'Failed to create action.');
            }

            if (paymentType === 'paypal') {
                if (result.approvalUrl) {
                    logMessage(`ACTION REQUIRED: Please complete the payment by visiting the URL opened in the new tab.`, 'info');
                    window.open(result.approvalUrl, '_blank');
                    logMessage(`Polling for status of Action ID: ${result.actionId}...`, 'info');
                    pollStatus(result.actionId);
                } else {
                    logMessage(`PayPal creation failed. Check backend logs. Test URL: ${result.testUrl}`, 'error');
                }
            } else { // Bank Transfer
                logMessage(`ACTION REQUIRED: A bank transfer action has been created.`, 'info');
                logMessage(`Action ID: ${result.actionId}`, 'info');
                logMessage(`Libell√©: ${result.libelle}`, 'info');
                logMessage(`Please use the Admin Panel above with the Action ID to validate the transfer.`, 'info');
                document.getElementById('actionIdToValidate').value = result.actionId;
            }

        } catch (error) {
            logMessage(`‚ùå Error during action creation: ${error.message}`, 'error');
        }
    }

    async function validateTransfer(workflowType) {
        const backendUrl = document.getElementById('backendUrl').value;
        const actionId = document.getElementById('actionIdToValidate').value;

        if (!actionId) {
            logMessage('Please enter an Action ID to validate.', 'error');
            return;
        }

        const endpoint = (workflowType === 'standard')
            ? `/api/actions/admin/validate-bank-transfer/${actionId}`
            : `/api/actions/admin/lahajati/validate-bank-transfer/${actionId}`;

        logMessage(`Validating bank transfer for Action ID: ${actionId}`, 'info');
        logMessage(`POST ${endpoint}`, 'req');

        try {
            const response = await fetch(`${backendUrl}${endpoint}`, {
                method: 'POST'
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || 'Validation failed.');
            }

            logMessage('‚úÖ Bank transfer validated successfully.', 'res', result);
            logMessage(`Polling for status of Action ID: ${actionId}...`, 'info');
            pollStatus(actionId);

        } catch (error) {
            logMessage(`‚ùå Error during validation: ${error.message}`, 'error');
        }
    }

    function pollStatus(actionId) {
        const backendUrl = document.getElementById('backendUrl').value;
        const interval = setInterval(async () => {
            try {
                const response = await fetch(`${backendUrl}/api/actions/status/${actionId}`);
                if (!response.ok) {
                    clearInterval(interval);
                    logMessage(`Error polling status for Action ID ${actionId}. Status: ${response.status}`, 'error');
                    return;
                }
                const action = await response.json();

                logMessage(`Polling... Action ID ${actionId}, Status: ${action.statutAction}`, 'info');

                if (action.statutAction === 'GENERE') {
                    clearInterval(interval);
                    logMessage(`üéâ SUCCESS! Audio generated for Action ID: ${actionId}.`, 'res');
                    createDownloadLink(action.audioGenerated, actionId);
                } else if (action.statutAction === 'REJETE') {
                    clearInterval(interval);
                    logMessage(`‚ùå FAILED! Action was rejected for Action ID: ${actionId}. Check backend logs.`, 'error');
                }
            } catch (error) {
                clearInterval(interval);
                logMessage(`Error during polling: ${error.message}`, 'error');
            }
        }, 3000); // Poll every 3 seconds
    }

    function createDownloadLink(base64Audio, actionId) {
        try {
            // Convert base64 string to byte array
            const byteCharacters = atob(base64Audio);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);

            // Create a blob from the byte array
            const blob = new Blob([byteArray], { type: 'audio/mpeg' });

            // Create a URL for the blob
            const url = URL.createObjectURL(blob);

            // Create and append the download link
            const link = document.createElement('a');
            link.href = url;
            link.download = `action_${actionId}_audio.mp3`;
            link.textContent = `Download Audio for Action ${actionId}`;
            link.className = 'download-link';

            const entry = document.createElement('div');
            entry.className = 'log-entry log-info';
            entry.appendChild(link);
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;

        } catch (error) {
            logMessage(`Error creating download link: ${error.message}`, 'error');
        }
    }
</script>

</body>
</html>